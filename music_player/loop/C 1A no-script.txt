string notecardName = "uuids";
integer notecardLine;
integer c = 80;
float rate = 0.1;
key notecardQueryId;
key notecardKey;
key keyUUID;
list songlist;
ReadNotecard()
{
    if (llGetInventoryKey(notecardName) == NULL_KEY)
    {
    llOwnerSay( "Notecard '" + notecardName + "' missing or unwritten.");
    return;
    }
    else if (llGetInventoryKey(notecardName) == notecardKey) return;
    notecardKey = llGetInventoryKey(notecardName);
    notecardQueryId = llGetNotecardLine(notecardName, notecardLine);
}
search_music(string search)
{
        integer Lengthx = llGetListLength(songlist); integer x;
        for ( ; x < Lengthx; x += 1)
        {
        string A = llToLower(search); string B = llToLower(llList2String(songlist, x));
        integer search_found = ~llSubStringIndex(B,A);
        if (search_found)
        { 
        list item = llParseString2List(llList2String(songlist, x), ["|"], []);
        llMessageLinked(LINK_THIS, 0,"playmusic_notecard"+"|"+llList2String(item, 1), NULL_KEY);
        llOwnerSay("Playing [ " + llList2String(item, 0) +" ]");
        return;
        }
    }llOwnerSay("could not find in database"); 
}
read_data(string soundname)
{
    if (llGetInventoryType(soundname) == INVENTORY_NONE)
    {
    search_music(soundname);
    return;
    }
    else
    {
    keyUUID = llGetInventoryKey(soundname);
    llMessageLinked(LINK_THIS, 0, "loop_music " +(string)keyUUID, NULL_KEY); 
    llOwnerSay("Playing [ " + soundname+" ]");
    return;
    }
}
list colors =[<1.000, 0.522, 0.106>,<0, 0, 0 >];
integer colornum = 0;
integer steps = 10;
integer index = 0;
color_pattern()
{
        float percent = (float)index / steps;
        vector from = llList2Vector (colors, colornum - 1) * (1.0 - percent);
        vector to = llList2Vector (colors, colornum) * percent;
        llSetLinkPrimitiveParamsFast(2, [PRIM_COLOR,ALL_SIDES,from + to,1]);
        index = index + 1;
        if (index >= steps)
        {
            index = 0;
            colornum = colornum + 1;
            if ( colornum >= llGetListLength (colors) )
            colornum = 0;
        }    
}
list pattern =[<0, 0,-.1>,<0, 0, 0 >];
integer patternnum = 0;
integer step_pattern = 10;
integer index_pattern = 0;
movement_pattern()
{
        float percent = (float)index_pattern / step_pattern;
        vector from = llList2Vector (pattern, patternnum - 1) * (1.0 - percent);
        vector to = llList2Vector (pattern, patternnum) * percent;
        llSetLinkPrimitiveParamsFast(2, [ PRIM_POS_LOCAL,from + to]);
        index_pattern = index_pattern + 1;
        if (index_pattern >= step_pattern)
        {
            index_pattern = 0;
            patternnum = patternnum + 1;
            if ( patternnum >= llGetListLength (pattern) )
            patternnum = 0;
        }    
}
default 
{
    on_rez(integer start_param) 
    {
    llResetScript();
    }
    changed(integer change)
    {
        if (change & CHANGED_INVENTORY)         
        {
        llResetScript();
        }
    } 
    run_time_permissions(integer perm)
    {
        if(PERMISSION_TAKE_CONTROLS & perm)
        {
        llTakeControls( CONTROL_BACK|CONTROL_FWD, TRUE, TRUE );
        }
    }
    state_entry() 
    {
    ReadNotecard();
    llSetTimerEvent(rate);
    llListen(c, "", llGetOwner(), "");
    llOwnerSay("/"+(string)c+" "+"menu"); 
    llSetLinkPrimitiveParams(2, [ PRIM_OMEGA, <0,0,1>,2,0.01]);
    llRequestPermissions(llGetOwner(), PERMISSION_TAKE_CONTROLS); 
    }
    listen(integer channel, string name, key id, string message)
    {
        if(llGetOwnerKey(id)==llGetOwner())
        if (message == "menu")
        {
        llMessageLinked(LINK_THIS, 0,"show_dialog","");
        }
    }
    link_message(integer sender_num, integer num, string msg, key id)
    {
        if(num == 0)
        {
            list params = llParseString2List(msg, [" "], []);
            string cmd = llList2String(params, 0);
            string param1 = llList2String(params, 1);
            if(cmd == "fetch_note_rationed")
            {
            string nname = llDumpList2String(llList2ListStrided(params, 1, -1, 1), " ");
            read_data(nname);
            }
        }
    }
    dataserver(key query_id, string data)
    {
        if (query_id == notecardQueryId)
        {
            if (data == EOF)
            {
            integer free_memory = llGetFreeMemory();
            llMessageLinked(LINK_THIS, 0, "memory_result"+"|"+(string)free_memory, NULL_KEY);
            }
            else
            {
            llMessageLinked(LINK_THIS, 0, "add_music"+"|"+data, NULL_KEY);
            songlist += data; ++notecardLine;
            notecardQueryId = llGetNotecardLine(notecardName, notecardLine); 
            }
        }
    }
    timer() 
    {
    color_pattern(); 
    movement_pattern();
    }
}