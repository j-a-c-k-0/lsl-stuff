key keyConfigQueryhandle;
key keyConfigUUID;
integer intLine1;
integer rat_mode;
integer c = 80;
string  note_name;
list note_contents;
sendratresults()
{
    llMessageLinked(LINK_THIS, 0, "upload_note " + llList2String(note_contents, 0), NULL_KEY);
    note_contents = [];
}
integer readnote(string notename)
{
    note_name = notename;
    if (llGetInventoryType(note_name) == INVENTORY_NONE)
    {
    return 0; 
    }
    else
    {
    intLine1 = 0; note_contents = []; 
    keyConfigQueryhandle = llGetNotecardLine(note_name, intLine1); 
    keyConfigUUID = llGetInventoryKey(note_name);
    return 1;
    }
}
default 
{
    on_rez(integer start_param) 
    {
    llResetScript();
    }  
    changed(integer change)
    {
        if (change & CHANGED_INVENTORY)         
        {
        llResetScript();
        }
    }
    run_time_permissions(integer perm)
    {
       if(PERMISSION_TAKE_CONTROLS & perm)
       {
       llTakeControls( CONTROL_BACK|CONTROL_FWD, TRUE, TRUE );
       }
    }
    state_entry() 
    {
    llListen(c, "", llGetOwner(), "");
    llOwnerSay("/"+(string)c+" "+"menu");
    llRequestPermissions(llGetOwner(), PERMISSION_TAKE_CONTROLS); 
    }
    listen(integer channel, string name, key id, string message)
    {
        if(llGetOwnerKey(id)==llGetOwner())
        if (message == "menu")
        {
        llMessageLinked(LINK_THIS, 0,"show_dialog","");
        }
    }
    link_message(integer sender_num, integer num, string msg, key id)
    {
        if(num == 0)
        {
            list params = llParseString2List(msg, [" "], []);
            string cmd = llList2String(params, 0);
            string param1 = llList2String(params, 1);
            if(cmd == "fetch_note")
            {
                string nname = llDumpList2String(llList2ListStrided(params, 1, -1, 1), " ");
                if(readnote(nname) == 0)
                {
                llMessageLinked(LINK_THIS, 0, "note_not_found " + nname, NULL_KEY);
                }
                rat_mode = 0;    
            }
            if(cmd == "fetch_note_rationed")
            {
                string nname = llDumpList2String(llList2ListStrided(params, 1, -1, 1), " ");
                if(readnote(nname) == 0)
                {
                llMessageLinked(LINK_THIS, 0, "note_not_found " + nname, NULL_KEY);
                }
                llMessageLinked(LINK_THIS, 0, "fn_ration_start " + nname, NULL_KEY);
                llOwnerSay("Playing [ " + nname+" ]");
                rat_mode = 1;
                
            }
        }
    }
    dataserver(key keyQueryId, string strData)
    {
        if (keyQueryId == keyConfigQueryhandle)
        {
            if (strData == EOF)
            {
            llMessageLinked(LINK_THIS,0,"start", NULL_KEY); 
            }
            else
            {
                keyConfigQueryhandle = llGetNotecardLine(note_name, ++intLine1);
                strData = llStringTrim(strData, STRING_TRIM_HEAD);
    
                if (llGetSubString (strData, 0, 0) != "#")
                {
                    note_contents += strData;
                    if(rat_mode == 1)
                    { 
                    sendratresults();
                    }
                }
            }
        }
    }
}