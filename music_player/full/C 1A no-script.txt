key keyConfigQueryhandle;
key keyConfigUUID;
integer intLine1;
integer rat_mode;
integer c = 80;
float rate = 0.1;
string  note_name;
list note_contents;
sendratresults()
{
    llMessageLinked(LINK_THIS, 0, "upload_note " + llList2String(note_contents, 0), NULL_KEY);
    note_contents = [];
}
integer readnote(string notename)
{
    note_name = notename;
    if (llGetInventoryType(note_name) == INVENTORY_NONE)
    {
    return 0; 
    }
    else
    {
    intLine1 = 0; note_contents = []; 
    keyConfigQueryhandle = llGetNotecardLine(note_name, intLine1); 
    keyConfigUUID = llGetInventoryKey(note_name);
    return 1;
    }
}
list colors =[<1.000, 0.522, 0.106>,<0, 0, 0 >];
integer colornum = 0;
integer steps = 10;
integer index = 0;
color_pattern()
{
        float percent = (float)index / steps;
        vector from = llList2Vector (colors, colornum - 1) * (1.0 - percent);
        vector to = llList2Vector (colors, colornum) * percent;
        llSetLinkPrimitiveParamsFast(2, [PRIM_COLOR,ALL_SIDES,from + to,1]);
        index = index + 1;
        if (index >= steps)
        {
            index = 0;
            colornum = colornum + 1;
            if ( colornum >= llGetListLength (colors) )
            colornum = 0;
        }    
}
list pattern =[<0, 0,-.1>,<0, 0, 0 >];
integer patternnum = 0;
integer step_pattern = 10;
integer index_pattern = 0;
movement_pattern()
{
        float percent = (float)index_pattern / step_pattern;
        vector from = llList2Vector (pattern, patternnum - 1) * (1.0 - percent);
        vector to = llList2Vector (pattern, patternnum) * percent;
        llSetLinkPrimitiveParamsFast(2, [ PRIM_POS_LOCAL,from + to]);
        index_pattern = index_pattern + 1;
        if (index_pattern >= step_pattern)
        {
            index_pattern = 0;
            patternnum = patternnum + 1;
            if ( patternnum >= llGetListLength (pattern) )
            patternnum = 0;
        }    
}
default 
{
    on_rez(integer start_param) 
    {
    llResetScript();
    }  
    changed(integer change)
    {
        if (change & CHANGED_INVENTORY)         
        {
        llResetScript();
        }
    }
    run_time_permissions(integer perm)
    {
       if(PERMISSION_TAKE_CONTROLS & perm)
       {
       llTakeControls( CONTROL_BACK|CONTROL_FWD, TRUE, TRUE );
       }
    }
    state_entry() 
    {
    llSetTimerEvent(rate);    
    llListen(c, "", llGetOwner(), "");
    llOwnerSay("/"+(string)c+" "+"menu");
    llSetLinkPrimitiveParams(2, [ PRIM_OMEGA, <0,0,1>,2,0.01]); 
    llRequestPermissions(llGetOwner(), PERMISSION_TAKE_CONTROLS); 
    }
    listen(integer channel, string name, key id, string message)
    {
        if(llGetOwnerKey(id)==llGetOwner())
        if (message == "menu")
        {
        llMessageLinked(LINK_THIS, 0,"show_dialog","");
        }
    }
    link_message(integer sender_num, integer num, string msg, key id)
    {
        if(num == 0)
        {
            list params = llParseString2List(msg, [" "], []);
            string cmd = llList2String(params, 0);
            string param1 = llList2String(params, 1);
            if(cmd == "fetch_note")
            {
                string nname = llDumpList2String(llList2ListStrided(params, 1, -1, 1), " ");
                if(readnote(nname) == 0)
                {
                llMessageLinked(LINK_THIS, 0, "note_not_found " + nname, NULL_KEY);
                }
                rat_mode = 0;    
            }
            if(cmd == "fetch_note_rationed")
            {
                string nname = llDumpList2String(llList2ListStrided(params, 1, -1, 1), " ");
                if(readnote(nname) == 0)
                {
                llMessageLinked(LINK_THIS, 0, "note_not_found " + nname, NULL_KEY);
                }
                llMessageLinked(LINK_THIS, 0, "fn_ration_start " + nname, NULL_KEY);
                llOwnerSay("Playing [ " + nname+" ]");
                rat_mode = 1;
                
            }
        }
    }
    dataserver(key keyQueryId, string strData)
    {
        if (keyQueryId == keyConfigQueryhandle)
        {
            if (strData == EOF)
            {
            llMessageLinked(LINK_THIS,0,"start", NULL_KEY); 
            }
            else
            {
                keyConfigQueryhandle = llGetNotecardLine(note_name, ++intLine1);
                strData = llStringTrim(strData, STRING_TRIM_HEAD);
    
                if (llGetSubString (strData, 0, 0) != "#")
                {
                    note_contents += strData;
                    if(rat_mode == 1)
                    { 
                    sendratresults();
                    }
                }
            }
        }
    }
    timer() 
    {
    color_pattern(); 
    movement_pattern();
    }
}